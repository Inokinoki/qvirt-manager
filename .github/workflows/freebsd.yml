name: FreeBSD CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  build-freebsd:
    name: Build on FreeBSD with Qt${{ matrix.qt_version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        qt_version: [5, 6]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build on FreeBSD
      uses: vmactions/freebsd-vm@v1
      with:
        envs: 'QT_VERSION_MAJOR=${{ matrix.qt_version }}'
        prepare: |
          # Update package repository
          pkg update -f
          # Install build dependencies
          pkg install -y \
            cmake \
            ninja \
            qt${{ matrix.qt_version }}-qtbase \
            qt${{ matrix.qt_version }}-qttools \
            libvirt \
            pkgconf \
            gmake \
            gcc \
            bash
        run: |
          echo "=== FreeBSD Build Environment ==="
          echo "Qt version: ${{ matrix.qt_version }}"
          uname -a
          cmake --version || echo "CMake not found"
          qmake-${{ matrix.qt_version }} --version || qmake6 --version || echo "qmake not found"

          echo "=== Starting Build ==="
          mkdir -p build
          cd build

          # Try CMake with Qt version detection
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr/local \
                -DQT_VERSION_MAJOR=${{ matrix.qt_version }} \
                -DCMAKE_DISABLE_FIND_PACKAGE_Libvirt=FALSE \
                .. || {
            echo "CMake configuration failed, trying without Qt version..."
            cmake -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_INSTALL_PREFIX=/usr/local \
                  .. || {
              echo "CMake failed with default settings"
              exit 1
            }
          }

          echo "=== Building ==="
          gmake -j$(sysctl -n hw.ncpu) || make -j$(sysctl -n hw.ncpu)

          echo "=== Running Tests ==="
          QT_QPA_PLATFORM=offscreen ctest --output-on-failure || echo "Tests skipped or failed"

          echo "=== Installing ==="
          sudo gmake install || sudo make install || echo "Install failed"

# Note: GitHub Actions doesn't natively support FreeBSD.
# This workflow uses vmactions/freebsd-vm which creates a temporary FreeBSD VM.
# Limitations:
# - Limited run time (free tier)
# - No caching support
# - May have intermittent network issues
#
# For production FreeBSD CI, consider:
# 1. Cirrus CI - has native FreeBSD support
# 2. Self-hosted runners on FreeBSD
# 3. Build validation only, don't block PRs
