name: FreeBSD CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  build-freebsd:
    name: Build on FreeBSD ${{ matrix.version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        version: ['13.2', '14.0']
        qt_version: [5, 6]
        include:
          - version: '13.2'
            iso_url: 'https://download.freebsd.org/releases/VM-IMAGEs/13.2-RELEASE/amd64/Latest/FreeBSD-13.2-RELEASE-amd64.qcow2.xz'
          - version: '14.0'
            iso_url: 'https://download.freebsd.org/releases/VM-IMAGEs/14.0-RELEASE/amd64/Latest/FreeBSD-14.0-RELEASE-amd64.qcow2.xz'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build on FreeBSD
      uses: vmactions/freebsd-vm@v1
      with:
        envs: 'QT_VERSION_MAJOR=${{ matrix.qt_version }}'
        prepare: |
          pkg install -y cmake qt${{ matrix.qt_version }}-qtbase qt${{ matrix.qt_version }}-qttools libvirt pkgconf
        run: |
          echo "Qt version: ${{ matrix.qt_version }}"
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DQT_VERSION_MAJOR=${{ matrix.qt_version }} ..
          make -j$(sysctl -n hw.ncpu)
          QT_QPA_PLATFORM=offscreen ctest --output-on-failure
          sudo make install

  build-freebsd-latest:
    name: Build on FreeBSD Latest
    runs-on: macos-12

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build in FreeBSD VM
      uses: cross-platform-actions/action@v0.24.0
      with:
        operating_system: freebsd
        version: '13.2'
        shell: bash
        run: |
          # Install dependencies
          sudo pkg install -y cmake qt6-qtbase qt6-qtools libvirt pkgconf gcc

          # Configure and build
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DQT_VERSION_MAJOR=6 ..
          make -j$(sysctl -n hw.ncpu)

          # Run tests
          QT_QPA_PLATFORM=offscreen ctest --output-on-failure

  build-freebsd-clang:
    name: Build with Clang on FreeBSD
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: FreeBSD build
      uses: vmactions/freebsd-vm@v1
      with:
        copyback: false
        prepare: |
          pkg install -y cmake qt6-qtbase libvirt
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_C_COMPILER=clang \
                -DCMAKE_CXX_COMPILER=clang++ \
                -DQT_VERSION_MAJOR=6 \
                ..
          make -j$(sysctl -n hw.ncpu)
          QT_QPA_PLATFORM=offscreen ctest --output-on-failure

  build-freebsd-gcc:
    name: Build with GCC on FreeBSD
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: FreeBSD build with GCC
      uses: vmactions/freebsd-vm@v1
      with:
        prepare: |
          pkg install -y cmake qt6-qtbase libvirt gcc
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_C_COMPILER=gcc \
                -DCMAKE_CXX_COMPILER=g++ \
                -DQT_VERSION_MAJOR=6 \
                ..
          make -j$(sysctl -n hw.ncpu)
          QT_QPA_PLATFORM=offscreen ctest --output-on-failure

  test-qt5-freebsd:
    name: Test Qt 5 on FreeBSD
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build with Qt 5
      uses: vmactions/freebsd-vm@v1
      with:
        prepare: |
          pkg install -y cmake qt5-qtbase qt5-qttools libvirt
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DQT_VERSION_MAJOR=5 ..
          make -j$(sysctl -n hw.ncpu)
          QT_QPA_PLATFORM=offscreen ctest --output-on-failure

  test-qt6-freebsd:
    name: Test Qt 6 on FreeBSD
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build with Qt 6
      uses: vmactions/freebsd-vm@v1
      with:
        prepare: |
          pkg install -y cmake qt6-qtbase qt6-qtools libvirt
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DQT_VERSION_MAJOR=6 ..
          make -j$(sysctl -n hw.ncpu)
          QT_QPA_PLATFORM=offscreen ctest --output-on-failure

  freebsd-sanitizers:
    name: FreeBSD with Sanitizers
    runs-on: ubuntu-latest

    strategy:
      matrix:
        sanitizer: [address, undefined]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build with sanitizers
      uses: vmactions/freebsd-vm@v1
      with:
        prepare: |
          pkg install -y cmake qt6-qtbase libvirt
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Debug \
                -DCMAKE_CXX_FLAGS="-fsanitize=${{ matrix.sanitizer}}" \
                -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=${{ matrix.sanitizer }}" \
                -DQT_VERSION_MAJOR=6 \
                ..
          make -j$(sysctl -n hw.ncpu)
          ASAN_OPTIONS=halt_on_error=0 QT_QPA_PLATFORM=offscreen ctest --output-on-failure

  freebsd-packages:
    name: Create FreeBSD Package
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build package
      uses: vmactions/freebsd-vm@v1
      with:
        copyback: true
        prepare: |
          pkg install -y cmake qt6-qtbase libvirt
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DQT_VERSION_MAJOR=6 ..
          make -j$(sysctl -n hw.ncpu)
          make package || true

    - name: Upload package
      uses: actions/upload-artifact@v4
      with:
        name: freebsd-package
        path: build/*.pkg
        retention-days: 7
      continue-on-error: true

# Note: GitHub Actions doesn't natively support FreeBSD.
# This workflow uses vmactions/freebsd-vm which creates a temporary FreeBSD VM.
# Alternatives include:
# 1. Cirrus CI - has native FreeBSD support
# 2. Self-hosted runners on FreeBSD
# 3. Custom FreeBSD runners with act
