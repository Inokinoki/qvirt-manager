name: Linux CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  build-ubuntu:
    name: Build on Ubuntu ${{ matrix.version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        version: ['20.04', '22.04', '24.04']
        qt_version: [5, 6]
        build_type: [Debug, Release]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Docker
      uses: docker-practice/actions-setup-docker@master

    - name: Build in Docker
      run: |
        docker build -t qvirt-builder:${{ matrix.version }}-qt${{ matrix.qt_version }} \
          --build-arg UBUNTU_VERSION=${{ matrix.version }} \
          --build-arg QT_VERSION=${{ matrix.qt_version }} \
          -f .github/docker/Dockerfile.ubuntu .

    - name: Run Build in Container
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          qvirt-builder:${{ matrix.version }}-qt${{ matrix.qt_version }} \
          bash -c "
            . /etc/profile.d/cmake-env.sh &&
            mkdir -p build && cd build &&
            cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                  -DQT_VERSION_MAJOR=${{ matrix.qt_version }} \
                  -DCMAKE_INSTALL_PREFIX=/usr .. &&
            make -j\$(nproc) &&
            (QT_QPA_PLATFORM=offscreen ctest --output-on-failure || true) &&
            make install || true
          "

  build-fedora:
    name: Build on Fedora ${{ matrix.version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        version: ['39', '40']
        qt_version: [5, 6]
        build_type: [Release]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build in Fedora container
      run: |
        docker run -v ${{ github.workspace }}:/workspace -w /workspace \
          docker.io/fedora:${{ matrix.version }} \
          bash -c "
            dnf install -y cmake qt${{ matrix.qt_version }}-qtbase-devel qt${{ matrix.qt_version }}-qttools-devel libvirt-devel gcc-c++ make &&
            mkdir -p build && cd build &&
            cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                  -DQT_VERSION_MAJOR=${{ matrix.qt_version }} \
                  -DCMAKE_INSTALL_PREFIX=/usr .. &&
            make -j\$(nproc) &&
            QT_QPA_PLATFORM=offscreen ctest --output-on-failure
          "

  build-arch:
    name: Build on Arch Linux
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build in Arch container
      run: |
        docker run -v ${{ github.workspace }}:/workspace -w /workspace \
          docker.io/archlinux:latest \
          bash -c "
            pacman -Syu --noconfirm base-devel cmake qt6-base qt6-tools libvirt &&
            mkdir -p build && cd build &&
            cmake -DCMAKE_BUILD_TYPE=Release -DQT_VERSION_MAJOR=6 .. &&
            make -j\$(nproc) &&
            QT_QPA_PLATFORM=offscreen ctest --output-on-failure
          "

  build-debian:
    name: Build on Debian ${{ matrix.version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        version: ['bullseye', 'bookworm']
        qt_version: [5, 6]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build in Debian container
      run: |
        docker run -v ${{ github.workspace }}:/workspace -w /workspace \
          docker.io/debian:${{ matrix.version }} \
          bash -c "
            apt-get update &&
            apt-get install -y cmake qtbase5-dev qttools5-dev qt6-base-dev qt6-tools-dev libvirt-dev build-essential pkg-config &&
            mkdir -p build && cd build &&
            cmake -DCMAKE_BUILD_TYPE=Release -DQT_VERSION_MAJOR=${{ matrix.qt_version }} .. &&
            make -j\$(nproc) &&
            QT_QPA_PLATFORM=offscreen ctest --output-on-failure
          "

  build-opensuse:
    name: Build on openSUSE ${{ matrix.version }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        version: ['tumbleweed', 'leap:15.5']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build in openSUSE container
      run: |
        docker run -v ${{ github.workspace }}:/workspace -w /workspace \
          docker.io/opensuse/${{ matrix.version }} \
          bash -c "
            zypper install -y cmake qt6-devel libvirt-devel gcc-c++ &&
            mkdir -p build && cd build &&
            cmake -DCMAKE_BUILD_TYPE=Release -DQT_VERSION_MAJOR=6 .. &&
            make -j\$(nproc) &&
            QT_QPA_PLATFORM=offscreen ctest --output-on-failure
          "

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake clang-tidy cppcheck qt6-base-dev qt6-tools-dev libvirt-dev

    - name: Configure for analysis
      run: |
        mkdir -p build
        cd build
        export Qt6_DIR="/usr/lib/x86_64-linux-gnu"
        export CMAKE_PREFIX_PATH="/usr/lib/x86_64-linux-gnu"
        cmake -DCMAKE_BUILD_TYPE=Debug -DQT_VERSION_MAJOR=6 ..

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --inconclusive --xml --xml-version=2 \
          --suppress=missingIncludeSystem \
          -I src/ src/ 2> cppcheck-report.xml || true

    - name: Run clang-tidy
      run: |
        cd build
        run-clang-tidy -p . '../src/**/*.cpp' -warnings-as-errors='' > clang-tidy-report.txt || true

    - name: Upload analysis reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: |
          cppcheck-report.xml
          clang-tidy-report.txt

  sanitizers:
    name: Build with Sanitizers
    runs-on: ubuntu-latest

    strategy:
      matrix:
        sanitizer: [address, undefined, thread]
        qt_version: [6]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake qt6-base-dev qt6-tools-dev libvirt-dev

    - name: Configure with ${{ matrix.sanitizer }} sanitizer
      run: |
        mkdir -p build
        export Qt6_DIR="/usr/lib/x86_64-linux-gnu"
        export CMAKE_PREFIX_PATH="/usr/lib/x86_64-linux-gnu"
        cd build
        cmake -DCMAKE_BUILD_TYPE=Debug \
              -DQT_VERSION_MAJOR=${{ matrix.qt_version }} \
              -DCMAKE_CXX_FLAGS="-fsanitize=${{ matrix.sanitizer}} -fno-omit-frame-pointer" \
              -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=${{ matrix.sanitizer}}" ..

    - name: Build
      run: |
        cd build
        make -j$(nproc)

    - name: Run tests
      run: |
        cd build
        ASAN_OPTIONS=detect_leaks=1:halt_on_error=0 UBSAN_OPTIONS=halt_on_error=0 \
        QT_QPA_PLATFORM=offscreen ctest --output-on-failure

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake qt6-base-dev qt6-tools-dev libvirt-dev lcov

    - name: Configure with coverage
      run: |
        mkdir -p build
        export Qt6_DIR="/usr/lib/x86_64-linux-gnu"
        export CMAKE_PREFIX_PATH="/usr/lib/x86_64-linux-gnu"
        cd build
        cmake -DCMAKE_BUILD_TYPE=Debug \
              -DQT_VERSION_MAJOR=6 \
              -DCMAKE_CXX_FLAGS="--coverage" \
              -DCMAKE_EXE_LINKER_FLAGS="--coverage" ..

    - name: Build
      run: |
        cd build
        make -j$(nproc)

    - name: Run tests
      run: |
        cd build
        QT_QPA_PLATFORM=offscreen ctest --output-on-failure

    - name: Generate coverage report
      run: |
        cd build
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' --output-file coverage.info
        lcov --list coverage.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./build/coverage.info
        flags: linux
        fail_ci_if_error: false
