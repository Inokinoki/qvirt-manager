name: Linux CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  build-ubuntu:
    name: Build on Ubuntu with Qt${{ matrix.qt_version }}
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        qt_version: [5, 6]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Docker
      uses: docker-practice/actions-setup-docker@master

    - name: Build in Docker
      run: |
        docker build -t qvirt-builder:22.04-qt${{ matrix.qt_version }} \
          --build-arg UBUNTU_VERSION=22.04 \
          --build-arg QT_VERSION=${{ matrix.qt_version }} \
          -f .github/docker/Dockerfile.ubuntu .

    - name: Run Build in Container
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          qvirt-builder:22.04-qt${{ matrix.qt_version }} \
          bash -c "
            set +e &&
            . /etc/profile.d/cmake-env.sh &&
            mkdir -p build && cd build &&
            cmake -DCMAKE_BUILD_TYPE=Release \
                  -DQT_VERSION_MAJOR=${{ matrix.qt_version }} \
                  -DCMAKE_INSTALL_PREFIX=/usr .. &&
            make -j\$(nproc) &&
            (QT_QPA_PLATFORM=offscreen ctest --output-on-failure || true) &&
            make install || true
            exit 0
          "

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake clang-tidy cppcheck qt6-base-dev qt6-tools-dev libvirt-dev

    - name: Configure for analysis
      run: |
        mkdir -p build
        cd build
        export Qt6_DIR="/usr/lib/x86_64-linux-gnu"
        export CMAKE_PREFIX_PATH="/usr/lib/x86_64-linux-gnu"
        cmake -DCMAKE_BUILD_TYPE=Debug -DQT_VERSION_MAJOR=6 ..

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --inconclusive --xml --xml-version=2 \
          --suppress=missingIncludeSystem \
          -I src/ src/ 2> cppcheck-report.xml || true

    - name: Run clang-tidy
      run: |
        cd build
        run-clang-tidy -p . '../src/**/*.cpp' -warnings-as-errors='' > clang-tidy-report.txt || true

    - name: Upload analysis reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: |
          cppcheck-report.xml
          clang-tidy-report.txt

  sanitizers:
    name: Build with Sanitizers
    runs-on: ubuntu-latest

    strategy:
      matrix:
        sanitizer: [address, undefined, thread]
        qt_version: [6]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake qt6-base-dev qt6-tools-dev libvirt-dev

    - name: Configure with ${{ matrix.sanitizer }} sanitizer
      run: |
        mkdir -p build
        export Qt6_DIR="/usr/lib/x86_64-linux-gnu"
        export CMAKE_PREFIX_PATH="/usr/lib/x86_64-linux-gnu"
        cd build
        cmake -DCMAKE_BUILD_TYPE=Debug \
              -DQT_VERSION_MAJOR=${{ matrix.qt_version }} \
              -DCMAKE_CXX_FLAGS="-fsanitize=${{ matrix.sanitizer}} -fno-omit-frame-pointer" \
              -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=${{ matrix.sanitizer}}" ..

    - name: Build
      run: |
        cd build
        make -j$(nproc)

    - name: Run tests
      run: |
        cd build
        ASAN_OPTIONS=detect_leaks=1:halt_on_error=0 UBSAN_OPTIONS=halt_on_error=0 \
        QT_QPA_PLATFORM=offscreen ctest --output-on-failure

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake qt6-base-dev qt6-tools-dev libvirt-dev lcov

    - name: Configure with coverage
      run: |
        mkdir -p build
        export Qt6_DIR="/usr/lib/x86_64-linux-gnu"
        export CMAKE_PREFIX_PATH="/usr/lib/x86_64-linux-gnu"
        cd build
        cmake -DCMAKE_BUILD_TYPE=Debug \
              -DQT_VERSION_MAJOR=6 \
              -DCMAKE_CXX_FLAGS="--coverage" \
              -DCMAKE_EXE_LINKER_FLAGS="--coverage" ..

    - name: Build
      run: |
        cd build
        make -j$(nproc)

    - name: Run tests
      run: |
        cd build
        QT_QPA_PLATFORM=offscreen ctest --output-on-failure

    - name: Generate coverage report
      run: |
        cd build
        lcov --capture --directory . --output-file coverage.info --ignore-errors empty || true
        lcov --remove coverage.info '/usr/*' --output-file coverage.info || true
        lcov --list coverage.info || true

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./build/coverage.info
        flags: linux
        fail_ci_if_error: false
