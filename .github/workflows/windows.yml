name: Windows CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  build:
    name: Build on Windows with Qt${{ matrix.qt_version }}
    runs-on: windows-latest

    strategy:
      matrix:
        qt_version: ['5.15.2', '6.5.3']
        include:
          - qt_version: '5.15.2'
            cmake_qt_flag: '5'
            modules: ''
          - qt_version: '6.5.3'
            cmake_qt_flag: '6'
            modules: 'qtserialport qtnetworkauth'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Qt for MinGW
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ matrix.qt_version }}
        host: 'windows'
        target: 'desktop'
        arch: 'mingw81_64'
        modules: ${{ matrix.modules }}
        cache: true

    - name: Install MSYS2 with libvirt
      uses: msys2/setup-msys2@v2
      with:
        msystem: CLANG64
        update: true
        install: >-
          mingw-w64-clang-x86_64-libvirt
          mingw-w64-clang-x86_64-cc
          mingw-w64-clang-x86_64-cmake
          mingw-w64-clang-x86_64-ninja
          mingw-w64-clang-x86_64-pkgconf
          mingw-w64-clang-x86_64-python
          tar
          gzip
        path-type: minimal

    - name: Build with MinGW and libvirt
      shell: msys2 {0}
      run: |
        echo "=== Building with MinGW/Clang and libvirt ==="

        # Set Qt path for MinGW
        export Qt_DIR="/c/Users/runneradmin/Qt/Qt${{ matrix.qt_version }}/mingw81_64"
        export CMAKE_PREFIX_PATH="$Qt_DIR"
        export PKG_CONFIG_PATH="/clang64/lib/pkgconfig:$PKG_CONFIG_PATH"

        # Configure CMake
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DQT_VERSION_MAJOR=${{ matrix.cmake_qt_flag }} \
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install \
          -DENABLE_LIBVIRT=ON

        # Build
        cmake --build build --config Release -j$(nproc)

        echo "=== Build complete ==="
      continue-on-error: false

    - name: Run Tests (if any)
      run: |
        cd build
        ctest -C Release --output-on-failure || echo "Tests may be skipped on Windows"
      continue-on-error: true

    - name: Install
      run: cmake --install build --config Release --prefix install
      continue-on-error: true

    - name: Package
      run: |
        Compress-Archive -Path install\* -DestinationPath qvirt-manager-windows-qt${{ matrix.cmake_qt_flag }}.zip
      continue-on-error: true

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qvirt-manager-windows-qt${{ matrix.cmake_qt_flag }}
        path: qvirt-manager-windows-qt${{ matrix.cmake_qt_flag }}.zip
        retention-days: 7
        if-no-files-found: ignore
      continue-on-error: true
